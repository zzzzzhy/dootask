apiVersion: apps/v1
kind: Deployment
metadata:
  name: dootask-office
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dootask-office
  template:
    metadata:
      labels:
        app: dootask-office
    spec:
      initContainers:
      - name: wait-for-job
        image: busybox
        command: ['sh', '-c', 'until [ -f "/app/success" ]; do echo "waiting for init-job to complete"; sleep 2; done']
        volumeMounts:
        - name: app-data
          mountPath: /app
      containers:
      - name: office
        image: onlyoffice/documentserver:8.2.2.1
        env:
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: dootask-secret
              key: APP_KEY
        volumeMounts:
        - name: app-data
          mountPath: /var/log/onlyoffice
          subPath: office/logs
        - name: app-data
          mountPath: /var/www/onlyoffice/Data
          subPath: office/data
        - name: app-data
          mountPath: /var/www/onlyoffice/documentserver/web-apps/vendor/requirejs/require.js
          subPath: office/resources/require.js
        - name: app-data
          mountPath: /var/www/onlyoffice/documentserver/web-apps/apps/common/main/resources/img/header
          subPath: office/resources/header
        - name: app-data
          mountPath: /var/www/onlyoffice/documentserver/web-apps/apps/documenteditor/main/resources/css/app.css
          subPath: office/resources/documenteditor/app.css
        - name: app-data
          mountPath: /var/www/onlyoffice/documentserver/web-apps/apps/documenteditor/mobile/css/526.caf35c11a8d72ca5ac85.css
          subPath: office/resources/documenteditor/mobile.css
        - name: app-data
          mountPath: /var/www/onlyoffice/documentserver/web-apps/apps/presentationeditor/main/resources/css/app.css
          subPath: office/resources/presentationeditor/app.css
        - name: app-data
          mountPath: /var/www/onlyoffice/documentserver/web-apps/apps/presentationeditor/mobile/css/923.f9cf19de1a25c2e7bf8b.css
          subPath: office/resources/presentationeditor/mobile.css
        - name: app-data
          mountPath: /var/www/onlyoffice/documentserver/web-apps/apps/spreadsheeteditor/main/resources/css/app.css
          subPath: office/resources/spreadsheeteditor/app.css
        - name: app-data
          mountPath: /var/www/onlyoffice/documentserver/web-apps/apps/spreadsheeteditor/mobile/css/611.1bef49f175e18fc085db.css
          subPath: office/resources/spreadsheeteditor/mobile.css
      volumes:
      - name: app-data
        persistentVolumeClaim:
          claimName: dootask-app-pvc
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dootask-fileview
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dootask-fileview
  template:
    metadata:
      labels:
        app: dootask-fileview
    spec:

      containers:
      - name: fileview
        image: kuaifan/fileview:4.2.0-SNAPSHOT-RC25
        env:
        - name: KK_CONTEXT_PATH
          value: "/fileview"
        - name: KK_OFFICE_PREVIEW_SWITCH_DISABLED
          value: "true"
        - name: KK_FILE_UPLOAD_ENABLED
          value: "true"
        - name: KK_MEDIA
          value: "mp3,wav,mp4,mov,avi,wmv"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dootask-drawio
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dootask-drawio
  template:
    metadata:
      labels:
        app: dootask-drawio
    spec:
      initContainers:
      - name: wait-for-job
        image: busybox
        command: ['sh', '-c', 'until [ -f "/app/success" ]; do echo "waiting for init-job to complete"; sleep 2; done']
        volumeMounts:
        - name: app-data
          mountPath: /app
      containers:
      - name: drawio-webapp
        image: jgraph/drawio:24.7.17
        volumeMounts:
        - name: app-data
          mountPath: /usr/local/tomcat/webapps/draw/index.html
          subPath: drawio/webapp/index.html
        - name: app-data
          mountPath: /usr/local/tomcat/webapps/draw/stencils
          subPath: drawio/webapp/stencils
        - name: app-data
          mountPath: /usr/local/tomcat/webapps/draw/js/app.min.js
          subPath: drawio/webapp/js/app.min.js
        - name: app-data
          mountPath: /usr/local/tomcat/webapps/draw/js/croppie/croppie.min.css
          subPath: drawio/webapp/js/croppie/croppie.min.css
        - name: app-data
          mountPath: /usr/local/tomcat/webapps/draw/js/diagramly/ElectronApp.js
          subPath: drawio/webapp/js/diagramly/ElectronApp.js
      - name: drawio-export
        image: kuaifan/export-server:0.0.1
        volumeMounts:
        - name: app-data
          mountPath: /usr/share/fonts/drawio
          subPath: drawio/export/fonts
      volumes:
      - name: app-data
        persistentVolumeClaim:
          claimName: dootask-app-pvc
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dootask-minder
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dootask-minder
  template:
    metadata:
      labels:
        app: dootask-minder
    spec:
      containers:
      - name: minder
        image: kuaifan/minder:0.1.3
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dootask-approve
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dootask-approve
  template:
    metadata:
      labels:
        app: dootask-approve
    spec:
      containers:
      - name: approve
        image: kuaifan/dooapprove:0.1.5
        env:
        - name: TZ
          valueFrom:
            configMapKeyRef:
              name: dootask-config
              key: TIMEZONE
        - name: MYSQL_HOST
          valueFrom:
            configMapKeyRef:
              name: dootask-config
              key: DB_HOST
        - name: MYSQL_PORT
          valueFrom:
            configMapKeyRef:
              name: dootask-config
              key: DB_PORT
        - name: MYSQL_DBNAME
          valueFrom:
            configMapKeyRef:
              name: dootask-config
              key: DB_DATABASE
        - name: MYSQL_USERNAME
          valueFrom:
            secretKeyRef:
              name: dootask-secret
              key: DB_USERNAME
        - name: MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: dootask-secret
              key: DB_PASSWORD
        - name: MYSQL_Prefix
          value: "${DB_PREFIX}approve_"
        - name: DEMO_DATA
          value: "true"
        - name: KEY
          valueFrom:
            secretKeyRef:
              name: dootask-secret
              key: APP_KEY
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dootask-ai
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dootask-ai
  template:
    metadata:
      labels:
        app: dootask-ai
    spec:
      containers:
      - name: ai
        image: kuaifan/dootask-ai:0.2.6
        env:
        - name: REDIS_HOST
          valueFrom:
            configMapKeyRef:
              name: dootask-config
              key: REDIS_HOST
        - name: REDIS_PORT
          valueFrom:
            configMapKeyRef:
              name: dootask-config
              key: REDIS_PORT
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dootask-okr
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dootask-okr
  template:
    metadata:
      labels:
        app: dootask-okr
    spec:
      containers:
      - name: okr
        image: kuaifan/doookr:0.4.5
        env:
        - name: TZ
          valueFrom:
            configMapKeyRef:
              name: dootask-config
              key: TIMEZONE
        - name: DOO_TASK_URL
          value: "http://dootask-nginx"
        - name: MYSQL_HOST
          valueFrom:
            configMapKeyRef:
              name: dootask-config
              key: DB_HOST
        - name: MYSQL_PORT
          valueFrom:
            configMapKeyRef:
              name: dootask-config
              key: DB_PORT
        - name: MYSQL_DBNAME
          valueFrom:
            configMapKeyRef:
              name: dootask-config
              key: DB_DATABASE
        - name: MYSQL_USERNAME
          valueFrom:
            secretKeyRef:
              name: dootask-secret
              key: DB_USERNAME
        - name: MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: dootask-secret
              key: DB_PASSWORD
        - name: MYSQL_PREFIX
          value: "${DB_PREFIX}"
        - name: DEMO_DATA
          value: "true"
        - name: KEY
          valueFrom:
            secretKeyRef:
              name: dootask-secret
              key: APP_KEY
---
# Services
apiVersion: v1
kind: Service
metadata:
  name: dootask-office
spec:
  ports:
  - port: 80
  selector:
    app: dootask-office
---
apiVersion: v1
kind: Service
metadata:
  name: dootask-fileview
spec:
  ports:
  - port: 80
  selector:
    app: dootask-fileview
---
apiVersion: v1
kind: Service
metadata:
  name: dootask-drawio
spec:
  ports:
  - port: 80
  selector:
    app: dootask-drawio
---
apiVersion: v1
kind: Service
metadata:
  name: dootask-minder
spec:
  ports:
  - port: 80
  selector:
    app: dootask-minder
---
apiVersion: v1
kind: Service
metadata:
  name: dootask-approve
spec:
  ports:
  - port: 80
  selector:
    app: dootask-approve
---
apiVersion: v1
kind: Service
metadata:
  name: dootask-ai
spec:
  ports:
  - port: 80
  selector:
    app: dootask-ai
---
apiVersion: v1
kind: Service
metadata:
  name: dootask-okr
spec:
  ports:
  - port: 80
  selector:
    app: dootask-okr
